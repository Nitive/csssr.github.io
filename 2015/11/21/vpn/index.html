<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Космический VPN для сурового фронтенда &#8211; CSSSR</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Или как поднять и настроить свой VPN сервер">
	<meta name="author" content="CSSSR">
	<meta name="keywords" content="">
	<link rel="canonical" href="/2015/11/21/vpn/">

	<!-- Custom CSS -->
	<link rel="stylesheet" href="/css/main.css" type="text/css">

	<!-- Open Graph -->
	<!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
	<meta property="og:locale" content="ru_RU">
	<meta property="og:type" content="article">
	<meta property="og:title" content="Космический VPN для сурового фронтенда">
	<meta property="og:description" content="Или как поднять и настроить свой VPN сервер">
	<meta property="og:url" content="/2015/11/21/vpn/">
	<meta property="og:site_name" content="CSSSR">
	

	<!-- Icons -->
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<link sizes="57x57" href="/apple-touch-icon-57x57.png" rel="apple-touch-icon">
	<link sizes="114x114" href="/apple-touch-icon-114x114.png" rel="apple-touch-icon">
	<link sizes="72x72" href="/apple-touch-icon-72x72.png" rel="apple-touch-icon">
	<link sizes="144x144" href="/apple-touch-icon-144x144.png" rel="apple-touch-icon">
	<link sizes="60x60" href="/apple-touch-icon-60x60.png" rel="apple-touch-icon">
	<link sizes="120x120" href="/apple-touch-icon-120x120.png" rel="apple-touch-icon">
	<link sizes="76x76" href="/apple-touch-icon-76x76.png" rel="apple-touch-icon">
	<link sizes="152x152" href="/apple-touch-icon-152x152.png" rel="apple-touch-icon">
	<link sizes="180x180" href="/apple-touch-icon-180x180.png" rel="apple-touch-icon">
	<link sizes="192x192" href="/favicon-192x192.png" rel="icon" type="image/png">
	<link sizes="160x160" href="/favicon-160x160.png" rel="icon" type="image/png">
	<link sizes="96x96" href="/favicon-96x96.png" rel="icon" type="image/png">
	<link sizes="16x16" href="/favicon-16x16.png" rel="icon" type="image/png">
	<link sizes="32x32" href="/favicon-32x32.png" rel="icon" type="image/png">
	<meta name="application-name" content="Космический VPN для сурового фронтенда">
	<meta name="msapplication-tooltip" content="Или как поднять и настроить свой VPN сервер">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/mstile-large.png">
	<meta name="msapplication-starturl" content="/2015/11/21/vpn/">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="msapplication-square70x70logo" content="/mstile-small.png">
	<meta name="msapplication-square150x150logo" content="/mstile-medium.png">
	<meta name="msapplication-wide310x150logo" content="/mstile-wide.png">
	<meta name="msapplication-square310x310logo" content="/mstile-large.png">
</head>

<body class="">
	<div class="site-wrap">
		<header class="site-header px2 px-responsive">
	<div class="wrap">
		<div class="measure">
			<a href="/" class="site-title"> </a>
			
				<div class="social-icons">
	<div class="left">
		
			<a class="icon icon_github" href="https://github.com/CSSSR"></a>
		
		<a class="icon icon_rss" href="/feed.xml"></a>
		
			<a class="icon icon_twitter" href="https://twitter.com/csssr_dev"></a>
		
		
			<a class="icon icon_envelope" href="mailto:hr@csssr.io"></a>
		
	</div>
</div>
			
		</div>
	</div>
	<div class="clearfix"></div>
</header>

		<div class="post p2 p-responsive wrap" role="main">
			<div class="measure">
				


<div class="post-header mb2">
	<h1>Космический VPN для сурового фронтенда</h1>
	<span class="post-meta">
		Nov 21, 2015
		
			by <a target="_blank" class="post-author" rel="author" href="https://twitter.com/pavel_azanov">Паша</a>
		
	</span><br>
	
	<span class="post-meta small">5 minute read</span>
</div>

<article class="post-content">
	<p><img src="/images/pazanov.png" alt="" /></p>

<p>Всем привет! С вами один из ведущих разработчиков CSSSR и просто путешественник.</p>

<p>Уже не раз мы писали о том, что CSSSR — это полностью распределенная компания. География сотрудников постепенно охватывает почти весь земной шар, и многие из нас постоянно в пути. Бывая в самых экзотических уголках вселенной, мы часто сталкиваемся с ограничениями доступа к определенным сервисам и ресурсам, будь то Github, Skype, WhatsApp или Facebook. Я решил рассказать как преодолеть эти ограничения, развернув свой собственный VPN сервер.</p>

<h4 id="чемодан-с-телефонами">Чемодан с телефонами</h4>

<p>При поиске средств для развертывания VPN самым важным было охватить все устройства, которые оказываются в моем чемодане во время путешествий. Ноутбук (Windows + Ubuntu), телефоны iPhone, Windows Phone, Android и с недавних пор MacBook Air. Все они поддерживают L2TP/IPSec, но иногда возникает необходимость подключиться через OpenVPN или SSTP. Посмотрев множество решений, в конце концов я остановился на <strong><a href="http://www.softether.org/">SoftEther VPN</a></strong>, разработанном в японском университете Tsukuba.</p>

<p><img src="/images/vpn/sofether.jpg" alt="" /></p>

<h4 id="выбор-сервера-и-страны-размещения">Выбор сервера и страны размещения</h4>

<p>Имея опыт использования платных VPN серверов, я хорошо понимал, что VPN должен путешествовать с тобой. Так, бессмысленно развертывать VPN в Сингапуре, если ты находишься в Европе. Путешествуя в Азии также не очень разумно использовать VPN сервера в Амстердаме или в Нью-йорке. Таким образом, помимо стабильного доступа и хорошей скорости, нужна возможность быстро развертывать VPN в другой точке галактики.</p>

<p>При выборе провайдера я решил остановиться на <strong><a href="https://www.digitalocean.com/">DigitalOcean</a></strong>, который за три года не подвел меня ни разу. Ребята предлагают размещение как в Европе и США, так и в Азии. Есть возможность делать образы серверов для их быстрого развертывания в новых локациях. Для VPN сервера вполне достаточно базового пакета за <strong>5$ / месяц</strong>, что равноценно стоимости чашки кофе в аэропорту. Новые клиенты могут воспользоваться купонами (например <code class="highlighter-rouge">ALLSSD10</code>), которые часто публикуют в официальном твиттере и в рекламе, или зарегистрироваться по <strong><a href="https://www.digitalocean.com/?refcode=d47158e015a5">реферальной ссылке</a></strong> и получить <strong>10$</strong> на счет.</p>

<h4 id="устанавливаем-vpn-сервер">Устанавливаем VPN сервер</h4>

<p>Для начала создаем новый Droplet в DigitalOcean. Я выбрал сервер за 5$ на базе Ubuntu 14 и разместил его в Нью-Йорке, это заняло у меня всего 30 секунд:</p>

<p><img src="/images/vpn/server.png" alt="" /></p>

<p>Первым делом обновляем пакеты:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get update &amp;&amp; apt-get upgrade
</code></pre></div></div>

<p>Устанавливаем зависимости:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get install git libreadline-dev libssl-dev libncurses5-dev zlib1g-dev make checkinstall
</code></pre></div></div>

<p>Клонируем репозиторий и настраиваем проект:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/SoftEtherVPN/SoftEtherVPN.git
cd SoftEtherVPN\
./configure
</code></pre></div></div>

<p>После вызова <code class="highlighter-rouge">configure</code> нужно ответить на пару вопросов, выбрать OS и разрядность. В моем случае это Linux и x64. Теперь можно собрать проект и установить VPN сервер:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
checkinstall
</code></pre></div></div>

<p>При создании пакета и установке также нужно будет ответить на пару вопросов, важный тут только самый первый, когда нужно указать имя для пакета. Я указал <code class="highlighter-rouge">csssrvpn</code>.</p>

<p>Теперь мы можем запустить наш VPN сервер:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vpnserver start
</code></pre></div></div>

<h4 id="настройка-vpn-сервера">Настройка VPN сервера</h4>

<p>Настройку можно произвести несколькими способами:</p>

<ol>
  <li>Через утилиту <code class="highlighter-rouge">vpncmd</code></li>
  <li>Отредактировав конфигурационный файл <code class="highlighter-rouge">vpn_server.config</code> (не рекомендуется)</li>
  <li>При помощи <a href="https://www.softether.org/4-docs/1-manual/2._SoftEther_VPN_Essential_Architecture/2.4_VPN_Server_Manager">SoftEther VPN Server Manager</a> (только для Windows).</li>
</ol>

<p>Последний способ самый крутой, интерфейс программы интуитивный и конфигурация занимает пару минут. Тем не менее, в этой статье я расскажу как сконфигурировать сервер при помощи <code class="highlighter-rouge">vpncmd</code>, так как не все читатели работают с Windows.</p>

<p>Запускаем <code class="highlighter-rouge">vpncmd</code>, нам будет предложено три варианта:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Management of VPN Server or VPN Bridge
2. Management of VPN Client
3. Use of VPN Tools (certificate creation and Network Traffic Speed Test Tool)
</code></pre></div></div>

<p>Выбираем <code class="highlighter-rouge">1. Management of VPN Server or VPN Bridge</code>, нам будет предложено указать адрес сервера для подключения, нажимаем <kbd>Enter</kbd> для подключение к локальному серверу. Далее последует выбор виртуального хаба, также просто жмем <kbd>Enter</kbd>.</p>

<p>Теперь можно приступить к конфигурации. Первым делом устанавливаем пароль для администрирования сервера:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ServerPasswordSet
</code></pre></div></div>

<p>Далее создаем новый виртуальный хаб, к которому в дальнейшем будут подключаться пользователи:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hubcreate csssrhub
</code></pre></div></div>

<p>Пароль для хаба указывать необязательно, так как мы не планируем делегировать администрирование хаба третьему лицу. После создания хаба, переключаемся в режим его администрирования:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hub csssrhub
</code></pre></div></div>

<p>Создание пользователей сводится к двум командам:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UserCreate
UserPasswordSet
</code></pre></div></div>

<p>Теперь включим для нашего хаба SecureNAT и DHCP. Выполняется это одной командой:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SecureNATEnable
</code></pre></div></div>

<p>Для Windows, MacOS, iOS, Android и Windows Phone (8.1+) можно использовать <strong>L2TP/IPSec</strong>, включаем:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IPsecEnable
</code></pre></div></div>

<p>На первые три вопроса отвечаем <code class="highlighter-rouge">yes</code>. Далее указываем ключ который позже будет использоваться для доступа к VPN серверу (Shared Key). После этого нам будет предложено выбрать стандартный хаб чтобы не добавлять его к имени пользователя каждый раз, вводим здесь название хаба созданного ранее (в моем случае <code class="highlighter-rouge">csssrhub</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Enable L2TP over IPsec Server Function (yes / no): yes
Enable Raw L2TP Server Function (yes / no): yes
Enable EtherIP / L2TPv3 over IPsec Server Function (yes / no): yes
Pre Shared Key for IPsec (Recommended: 9 letters at maximum): MyVPN
Default Virtual HUB in a case of omitting the HUB on the Username: csssrhub
</code></pre></div></div>

<p>На этом конфигурация L2TP/IPSec закончена и можно опробовать подключение.</p>

<h4 id="l2tp-подключение-в-ios">L2TP подключение в iOS</h4>

<p><img src="/images/vpn/ios.png" alt="" /></p>

<p>Настройка Android и Windows Phone производится аналогично. Для MacOS настройки также отличаются не очень сильно.</p>

<h4 id="lt2pipsec-подключение-в-windows">LT2P/IPSec подключение в Windows</h4>

<p>В Windows создаем обычное VPN подключение и затем настраиваем его.</p>

<p><img src="/images/vpn/1.png" alt="" /></p>

<p>В свойствах подключения меняем тип на L2TP/IPSec:</p>

<p><img src="/images/vpn/6.png" alt="" /></p>

<p>И указываем Shared Key в дополнительных настройках:</p>

<p><img src="/images/vpn/7.png" alt="" /></p>

<p>Всё готово!</p>

<h4 id="заключение">Заключение</h4>

<p>При помощи SoftEther VPN у меня очень быстро получилось поднять свой собственный VPN сервер. Помимо L2TP/IPSec также не составит труда настроить поддержку SSTP и OpenVPN. К сожалению, пока нет поддержки IKEv2, но я надеюсь, что в скором времени она появится.</p>

<p>Желаю всем беззаботных путешествий! Ждём ваших комментариев в <a href="https://twitter.com/csssr_dev">Твиттере</a>!</p>

</article>






<div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'blogcsssrru';

	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

			</div>
		</div>
	</div>


	<script type="text/javascript">
	(function (d, w, c) {
		(w[c] = w[c] || []).push(function() {
			try {
				w.yaCounter25896539 = new Ya.Metrika({id:25896539,
						webvisor:true,
						clickmap:true,
						trackLinks:true,
						accurateTrackBounce:true});
			} catch(e) { }
		});

		var n = d.getElementsByTagName("script")[0],
			s = d.createElement("script"),
			f = function () { n.parentNode.insertBefore(s, n); };
		s.type = "text/javascript";
		s.async = true;
		s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

		if (w.opera == "[object Opera]") {
			d.addEventListener("DOMContentLoaded", f, false);
		} else { f(); }
	})(document, window, "yandex_metrika_callbacks");
	</script>
	<noscript><div><img src="//mc.yandex.ru/watch/25896539" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

</body>
</html>
